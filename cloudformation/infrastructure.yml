AWSTemplateFormatVersion: '2010-09-09'
Description: Kisanlink Shared VPC Infrastructure - AAA, Farmers, and shared resources for ERP services

Parameters:
  EnvironmentName:
    Type: String
    Default: beta
    AllowedValues:
      - beta
      - staging
      - production
    Description: Environment name (beta/staging/production)

  VpcCIDR:
    Type: String
    Default: 10.100.0.0/16
    Description: VPC CIDR block

  # AAA Service Parameters - Database credentials for RDS creation
  AAADBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Password for AAA RDS database (used to create RDS instance)

  AAARedisAuthToken:
    Type: String
    NoEcho: true
    MinLength: 16
    Description: Redis AUTH token (min 16 chars, used to create ElastiCache)

  # Farmers Service Parameters - Database credentials for RDS creation
  FarmersDBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Password for Farmers RDS database (used to create RDS instance)

  # AAA JWT Secret
  AAAJWTSecret:
    Type: String
    NoEcho: true
    MinLength: 32
    Description: JWT signing secret for AAA service (min 32 chars)

  # Seed Admin Credentials
  SeedSuperAdminPhone:
    Type: String
    Description: Phone number for super admin seed user

  SeedSuperAdminPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Password for super admin seed user

  SeedAdminPhone:
    Type: String
    Description: Phone number for admin seed user

  SeedAdminPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Password for admin seed user

  # ACM Certificate
  ACMCertificateArn:
    Type: String
    Description: ARN of ACM certificate for *.beta.kisanlink.in (must be pre-created)

  # Domain Configuration
  DomainSuffix:
    Type: String
    Default: beta.api.kisanlink.in
    Description: Domain suffix for services (e.g., beta.api.kisanlink.in)

  CookieDomain:
    Type: String
    Default: .beta.api.kisanlink.in
    Description: Cookie domain for cross-subdomain auth

  # Aadhaar API Credentials
  AadhaarSandboxApiKey:
    Type: String
    NoEcho: true
    Description: Aadhaar sandbox API key

  AadhaarSandboxApiSecret:
    Type: String
    NoEcho: true
    Description: Aadhaar sandbox API secret

  # SMS Configuration
  SMSSenderId:
    Type: String
    Default: KSNLNK
    Description: SMS sender ID for SNS

  # Farmers Service Secrets
  FarmersAAAApiKey:
    Type: String
    NoEcho: true
    Description: API key for Farmers to authenticate with AAA service

  FarmersAAADefaultPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Description: Default password used by Farmers service for AAA operations

Conditions:
  IsProduction: !Equals [!Ref EnvironmentName, 'production']

Resources:
  # ===========================================
  # VPC and Networking
  # ===========================================
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-igw

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # Public Subnets (for ALB, NAT Gateway)
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Select [0, !Cidr [!Ref VpcCIDR, 16, 8]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-public-1a

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Select [1, !Cidr [!Ref VpcCIDR, 16, 8]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-public-1b

  # Private Subnets (for ECS services)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Select [2, !Cidr [!Ref VpcCIDR, 16, 8]]
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-private-1a

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Select [3, !Cidr [!Ref VpcCIDR, 16, 8]]
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-private-1b

  # Database Subnets
  DBSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Select [10, !Cidr [!Ref VpcCIDR, 16, 8]]
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-db-1a

  DBSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Select [11, !Cidr [!Ref VpcCIDR, 16, 8]]
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-db-1b

  # NAT Gateway (Single AZ for staging, saves ~$32/month)
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-nat-eip

  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-nat

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-public-rt

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-private-rt

  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref PrivateSubnet2

  DBSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref DBSubnet1

  DBSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      SubnetId: !Ref DBSubnet2

  # ===========================================
  # VPC Endpoints (Reduce NAT costs)
  # ===========================================
  VPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC endpoints
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref VpcCIDR
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-vpce-sg

  S3GatewayEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PrivateRouteTable

  ECRApiEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.api
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  ECRDkrEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.ecr.dkr
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  SecretsManagerEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.secretsmanager
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  CloudWatchLogsEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.logs
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      SecurityGroupIds:
        - !Ref VPCEndpointSecurityGroup
      PrivateDnsEnabled: true

  # ===========================================
  # Security Groups
  # ===========================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for shared ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-alb-sg

  AAASecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AAA service
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-aaa-sg

  FarmersSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Farmers module
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-farmers-sg

  ERPSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for all ERP services
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: HTTP from ALB
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-erp-sg

  # gRPC ingress rules for AAA (from Farmers and ERP)
  AAAGrpcFromFarmers:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref AAASecurityGroup
      IpProtocol: tcp
      FromPort: 50051
      ToPort: 50051
      SourceSecurityGroupId: !Ref FarmersSecurityGroup
      Description: gRPC from Farmers

  AAAGrpcFromERP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref AAASecurityGroup
      IpProtocol: tcp
      FromPort: 50051
      ToPort: 50051
      SourceSecurityGroupId: !Ref ERPSecurityGroup
      Description: gRPC from ERP

  # Database Security Groups
  AAARDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for AAA database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref AAASecurityGroup
          Description: From AAA service
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-aaa-rds-sg

  FarmersRDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Farmers database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref FarmersSecurityGroup
          Description: From Farmers service
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-farmers-rds-sg

  ERPRDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for ERP databases
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ERPSecurityGroup
          Description: From ERP services
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-erp-rds-sg

  RedisSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Redis
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref AAASecurityGroup
          Description: From AAA service
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-redis-sg

  # ===========================================
  # DB Subnet Group
  # ===========================================
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Database subnet group for shared VPC
      SubnetIds:
        - !Ref DBSubnet1
        - !Ref DBSubnet2
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-db-subnet-group

  # ===========================================
  # Cloud Map (Service Discovery)
  # ===========================================
  ServiceDiscoveryNamespace:
    Type: AWS::ServiceDiscovery::PrivateDnsNamespace
    Properties:
      Name: !Sub kisanlink-${EnvironmentName}.local
      Description: Private DNS for Kisanlink services
      Vpc: !Ref VPC

  AAAServiceDiscovery:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      Name: aaa
      NamespaceId: !Ref ServiceDiscoveryNamespace
      DnsConfig:
        DnsRecords:
          - Type: A
            TTL: 10
        RoutingPolicy: MULTIVALUE
      HealthCheckCustomConfig:
        FailureThreshold: 1

  # ===========================================
  # Application Load Balancer
  # ===========================================
  ALB:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub kisanlink-shared-${EnvironmentName}-alb
      Type: application
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub kisanlink-shared-${EnvironmentName}-alb

  # HTTP Listener (redirect to HTTPS)
  HTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301

  # HTTPS Listener
  HTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref ALB
      Port: 443
      Protocol: HTTPS
      SslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06
      Certificates:
        - CertificateArn: !Ref ACMCertificateArn
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: '404'
            ContentType: text/plain
            MessageBody: 'Service not found'

  # ===========================================
  # Target Groups
  # ===========================================
  AAATargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub kisanlink-${EnvironmentName}-aaa-tg
      Port: 8080
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckEnabled: true
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '30'

  FarmersTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub kisanlink-${EnvironmentName}-farmers-tg
      Port: 8000
      Protocol: HTTP
      TargetType: ip
      VpcId: !Ref VPC
      HealthCheckEnabled: true
      HealthCheckPath: /health
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: '30'

  # ===========================================
  # ALB Listener Rules
  # ===========================================
  AAAListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HTTPSListener
      Priority: 10
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Sub aaa.${DomainSuffix}
      Actions:
        - Type: forward
          TargetGroupArn: !Ref AAATargetGroup

  FarmersListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HTTPSListener
      Priority: 20
      Conditions:
        - Field: host-header
          HostHeaderConfig:
            Values:
              - !Sub fm.${DomainSuffix}
      Actions:
        - Type: forward
          TargetGroupArn: !Ref FarmersTargetGroup

  # ===========================================
  # ECS Cluster
  # ===========================================
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub kisanlink-shared-${EnvironmentName}-cluster
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1
          Base: 1
        - CapacityProvider: FARGATE_SPOT
          Weight: 3
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

  # ===========================================
  # IAM Roles
  # ===========================================
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub kisanlink-${EnvironmentName}-ecs-exec-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: SecretsAccess
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - kms:Decrypt
                Resource: '*'

  AAATaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub kisanlink-${EnvironmentName}-aaa-task-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AAAPermissions
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::kisanlink-aaa-photos-${EnvironmentName}
                  - !Sub arn:aws:s3:::kisanlink-aaa-photos-${EnvironmentName}/*
              - Effect: Allow
                Action:
                  - sns:Publish
                Resource: '*'

  FarmersTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub kisanlink-${EnvironmentName}-farmers-task-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FarmersPermissions
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Resource: '*'

  ERPTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub kisanlink-${EnvironmentName}-erp-task-role
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: ERPPermissions
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::kisanlink-erp-attachments-${EnvironmentName}
                  - !Sub arn:aws:s3:::kisanlink-erp-attachments-${EnvironmentName}/*
              - Effect: Allow
                Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Resource: '*'

  # ===========================================
  # Secrets Manager
  # ===========================================
  # NOTE: All secrets use DeletionPolicy: Retain.
  # Deleting this stack will NOT delete the secrets.
  # DB/Redis host values are auto-populated from RDS/ElastiCache endpoints via !GetAtt.

  AAADBSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub aaa-service/${EnvironmentName}/db
      Description: AAA service database credentials
      SecretString: !Sub
        - |
          {
            "host": "${DBHost}",
            "username": "postgres",
            "password": "${AAADBPassword}"
          }
        - DBHost: !GetAtt AAARDSInstance.Endpoint.Address

  AAAJWTSecretResource:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub aaa-service/${EnvironmentName}/jwt
      Description: AAA service JWT signing secret
      SecretString: !Sub |
        {
          "AAA_JWT_SECRET": "${AAAJWTSecret}"
        }

  AAARedisSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub aaa-service/${EnvironmentName}/redis
      Description: AAA service Redis credentials
      SecretString: !Sub
        - |
          {
            "REDIS_HOST": "${RedisHost}",
            "REDIS_PASSWORD": "${AAARedisAuthToken}"
          }
        - RedisHost: !GetAtt RedisCluster.PrimaryEndPoint.Address

  AAASeedSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub aaa-service/${EnvironmentName}/seed-admin
      Description: AAA service seed admin credentials
      SecretString: !Sub |
        {
          "SEED_SUPERADMIN_PHONE": "${SeedSuperAdminPhone}",
          "SEED_SUPERADMIN_PASSWORD": "${SeedSuperAdminPassword}",
          "SEED_ADMIN_PHONE": "${SeedAdminPhone}",
          "SEED_ADMIN_PASSWORD": "${SeedAdminPassword}"
        }

  FarmersDBSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub farmers-module/${EnvironmentName}/db
      Description: Farmers module database credentials
      SecretString: !Sub
        - |
          {
            "host": "${DBHost}",
            "username": "postgres",
            "password": "${FarmersDBPassword}"
          }
        - DBHost: !GetAtt FarmersRDSInstance.Endpoint.Address

  AAAExternalAPISecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub aaa-service/${EnvironmentName}/external-api
      Description: AAA service external API credentials (Aadhaar)
      SecretString: !Sub |
        {
          "AADHAAR_SANDBOX_API_KEY": "${AadhaarSandboxApiKey}",
          "AADHAAR_SANDBOX_API_SECRET": "${AadhaarSandboxApiSecret}"
        }

  FarmersServiceSecret:
    Type: AWS::SecretsManager::Secret
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      Name: !Sub farmers-module/${EnvironmentName}/service-config
      Description: Farmers module service integration secrets
      SecretString: !Sub |
        {
          "AAA_API_KEY": "${FarmersAAAApiKey}",
          "AAA_DEFAULT_PASSWORD": "${FarmersAAADefaultPassword}"
        }

  # ===========================================
  # RDS Instances
  # ===========================================
  AAARDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub aaa-service-shared-${EnvironmentName}-db
      DBName: aaa_service
      Engine: postgres
      EngineVersion: '16.4'
      DBInstanceClass: db.t4g.micro
      AllocatedStorage: 20
      MaxAllocatedStorage: 100
      StorageType: gp3
      StorageEncrypted: true
      MasterUsername: postgres
      MasterUserPassword: !Ref AAADBPassword
      VPCSecurityGroups:
        - !Ref AAARDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: !If [IsProduction, 7, 3]
      MultiAZ: false
      PubliclyAccessible: false
      DeletionProtection: !If [IsProduction, true, false]
      Tags:
        - Key: Name
          Value: !Sub aaa-service-shared-${EnvironmentName}-db

  FarmersRDSInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    UpdateReplacePolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub farmers-module-shared-${EnvironmentName}-db
      DBName: farmers_module
      Engine: postgres
      EngineVersion: '16.4'
      DBInstanceClass: db.t4g.small
      AllocatedStorage: 20
      MaxAllocatedStorage: 100
      StorageType: gp3
      StorageEncrypted: true
      MasterUsername: postgres
      MasterUserPassword: !Ref FarmersDBPassword
      VPCSecurityGroups:
        - !Ref FarmersRDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: !If [IsProduction, 7, 3]
      MultiAZ: false
      PubliclyAccessible: false
      DeletionProtection: !If [IsProduction, true, false]
      Tags:
        - Key: Name
          Value: !Sub farmers-module-shared-${EnvironmentName}-db

  # ===========================================
  # ElastiCache Redis
  # ===========================================
  RedisSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Redis subnet group for shared VPC
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  RedisCluster:
    Type: AWS::ElastiCache::ReplicationGroup
    Properties:
      ReplicationGroupId: !Sub aaa-shared-${EnvironmentName}-redis
      ReplicationGroupDescription: Redis for AAA service
      Engine: redis
      EngineVersion: '7.1'
      CacheNodeType: cache.t4g.micro
      NumCacheClusters: 1
      AutomaticFailoverEnabled: false
      MultiAZEnabled: false
      CacheSubnetGroupName: !Ref RedisSubnetGroup
      SecurityGroupIds:
        - !Ref RedisSecurityGroup
      AtRestEncryptionEnabled: true
      TransitEncryptionEnabled: true
      AuthToken: !Ref AAARedisAuthToken
      SnapshotRetentionLimit: !If [IsProduction, 5, 1]

  # ===========================================
  # CloudWatch Log Groups
  # ===========================================
  AAALogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/kisanlink-${EnvironmentName}/aaa-service
      RetentionInDays: !If [IsProduction, 14, 7]

  FarmersLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/kisanlink-${EnvironmentName}/farmers-module
      RetentionInDays: !If [IsProduction, 14, 7]

  # ===========================================
  # ECS Task Definitions
  # ===========================================
  AAATaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub aaa-service-shared-${EnvironmentName}
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: '512'
      Memory: '1024'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt AAATaskRole.Arn
      ContainerDefinitions:
        - Name: aaa-service
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/aaa-service:latest
          Essential: true
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
            - ContainerPort: 50051
              Protocol: tcp
          Environment:
            - Name: APP_ENV
              Value: !Ref EnvironmentName
            - Name: GIN_MODE
              Value: release
            - Name: HTTP_PORT
              Value: '8080'
            - Name: GRPC_PORT
              Value: '50051'
            - Name: DB_PRIMARY_BACKEND
              Value: postgres
            - Name: DB_POSTGRES_PORT
              Value: '5432'
            - Name: DB_POSTGRES_SSLMODE
              Value: require
            - Name: DB_POSTGRES_DBNAME
              Value: aaa_service
            - Name: REDIS_PORT
              Value: '6379'
            - Name: REDIS_TLS_ENABLED
              Value: 'true'
            - Name: AAA_AUTO_MIGRATE
              Value: 'true'
            - Name: AAA_ENABLE_DOCS
              Value: 'true'
            - Name: LOG_LEVEL
              Value: info
            - Name: AWS_REGION
              Value: !Ref AWS::Region
            - Name: AAA_CORS_ALLOWED_ORIGINS
              Value: !Sub https://*.${DomainSuffix}
            - Name: AAA_COOKIE_DOMAIN
              Value: !Ref CookieDomain
            # Aadhaar Integration
            - Name: AADHAAR_SANDBOX_URL
              Value: https://api.sandbox.co.in
            # S3 Photo Storage
            - Name: AWS_S3_BUCKET
              Value: !Sub kisanlink-aaa-photos-${EnvironmentName}
            # OTP Configuration
            - Name: OTP_EXPIRATION_SECONDS
              Value: '300'
            - Name: OTP_MAX_ATTEMPTS
              Value: '3'
            - Name: OTP_COOLDOWN_SECONDS
              Value: '60'
            # Photo Upload
            - Name: PHOTO_MAX_SIZE_MB
              Value: '5'
            # SMS Configuration
            - Name: SMS_ENABLED
              Value: 'false'
            - Name: SMS_SENDER_ID
              Value: !Ref SMSSenderId
            - Name: SMS_MESSAGE_TYPE
              Value: Transactional
            - Name: SMS_OTP_EXPIRY_MINUTES
              Value: '5'
            - Name: SMS_MAX_PER_HOUR
              Value: '10'
            - Name: SMS_MAX_PER_DAY
              Value: '50'
          Secrets:
            - Name: DB_POSTGRES_HOST
              ValueFrom: !Sub ${AAADBSecret}:host::
            - Name: DB_POSTGRES_USER
              ValueFrom: !Sub ${AAADBSecret}:username::
            - Name: DB_POSTGRES_PASSWORD
              ValueFrom: !Sub ${AAADBSecret}:password::
            - Name: REDIS_HOST
              ValueFrom: !Sub ${AAARedisSecret}:REDIS_HOST::
            - Name: REDIS_PASSWORD
              ValueFrom: !Sub ${AAARedisSecret}:REDIS_PASSWORD::
            - Name: AAA_JWT_SECRET
              ValueFrom: !Sub ${AAAJWTSecretResource}:AAA_JWT_SECRET::
            - Name: SEED_SUPERADMIN_PHONE
              ValueFrom: !Sub ${AAASeedSecret}:SEED_SUPERADMIN_PHONE::
            - Name: SEED_SUPERADMIN_PASSWORD
              ValueFrom: !Sub ${AAASeedSecret}:SEED_SUPERADMIN_PASSWORD::
            - Name: SEED_ADMIN_PHONE
              ValueFrom: !Sub ${AAASeedSecret}:SEED_ADMIN_PHONE::
            - Name: SEED_ADMIN_PASSWORD
              ValueFrom: !Sub ${AAASeedSecret}:SEED_ADMIN_PASSWORD::
            - Name: AADHAAR_SANDBOX_API_KEY
              ValueFrom: !Sub ${AAAExternalAPISecret}:AADHAAR_SANDBOX_API_KEY::
            - Name: AADHAAR_SANDBOX_API_SECRET
              ValueFrom: !Sub ${AAAExternalAPISecret}:AADHAAR_SANDBOX_API_SECRET::
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref AAALogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
          HealthCheck:
            Command:
              - CMD-SHELL
              - curl -f http://localhost:8080/health || exit 1
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 60

  FarmersTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub farmers-module-shared-${EnvironmentName}
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Cpu: '1024'
      Memory: '2048'
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt FarmersTaskRole.Arn
      ContainerDefinitions:
        - Name: farmers-module
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/farmers-module:latest
          Essential: true
          PortMappings:
            - ContainerPort: 8000
              Protocol: tcp
          Environment:
            - Name: SERVICE_NAME
              Value: farmers-module
            - Name: SERVICE_PORT
              Value: '8000'
            - Name: ENVIRONMENT
              Value: !Ref EnvironmentName
            - Name: LOG_LEVEL
              Value: info
            - Name: DB_POSTGRES_PORT
              Value: '5432'
            - Name: DB_POSTGRES_SSLMODE
              Value: require
            - Name: DB_POSTGRES_DBNAME
              Value: farmers_module
            - Name: DB_POSTGRES_MAX_CONNS
              Value: '10'
            - Name: AAA_ENABLED
              Value: 'true'
            - Name: AAA_GRPC_ADDR
              Value: !Sub aaa.kisanlink-${EnvironmentName}.local:50051
            - Name: AAA_REQUEST_TIMEOUT
              Value: 30s
            - Name: AAA_RETRY_ATTEMPTS
              Value: '3'
            - Name: AAA_RETRY_BACKOFF
              Value: 1s
            - Name: CORS_ALLOWED_ORIGINS
              Value: !Sub https://*.${DomainSuffix}
            - Name: CORS_ALLOW_CREDENTIALS
              Value: 'true'
            # Observability (disabled — no OTEL collector in CF)
            - Name: ENABLE_TRACING
              Value: 'false'
            - Name: ENABLE_METRICS
              Value: 'false'
          Secrets:
            - Name: DB_POSTGRES_HOST
              ValueFrom: !Sub ${FarmersDBSecret}:host::
            - Name: DB_POSTGRES_USER
              ValueFrom: !Sub ${FarmersDBSecret}:username::
            - Name: DB_POSTGRES_PASSWORD
              ValueFrom: !Sub ${FarmersDBSecret}:password::
            # JWT secret — shared with AAA (single source of truth)
            - Name: JWT_SECRET
              ValueFrom: !Sub ${AAAJWTSecretResource}:AAA_JWT_SECRET::
            # Service integration secrets
            - Name: AAA_API_KEY
              ValueFrom: !Sub ${FarmersServiceSecret}:AAA_API_KEY::
            - Name: AAA_DEFAULT_PASSWORD
              ValueFrom: !Sub ${FarmersServiceSecret}:AAA_DEFAULT_PASSWORD::
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref FarmersLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs
          HealthCheck:
            Command:
              - CMD-SHELL
              - curl -f http://localhost:8000/health || exit 1
            Interval: 30
            Timeout: 5
            Retries: 3
            StartPeriod: 60

  # ===========================================
  # ECS Services
  # ===========================================
  AAAService:
    Type: AWS::ECS::Service
    DependsOn:
      - AAAListenerRule
    Properties:
      ServiceName: !Sub aaa-service-shared-${EnvironmentName}
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref AAATaskDefinition
      DesiredCount: 1
      LaunchType: FARGATE
      PlatformVersion: LATEST
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref AAASecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
      LoadBalancers:
        - ContainerName: aaa-service
          ContainerPort: 8080
          TargetGroupArn: !Ref AAATargetGroup
      ServiceRegistries:
        - RegistryArn: !GetAtt AAAServiceDiscovery.Arn
          ContainerName: aaa-service
          ContainerPort: 50051
      HealthCheckGracePeriodSeconds: 120
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true

  FarmersService:
    Type: AWS::ECS::Service
    DependsOn:
      - FarmersListenerRule
      - AAAService
    Properties:
      ServiceName: !Sub farmers-module-shared-${EnvironmentName}
      Cluster: !Ref ECSCluster
      TaskDefinition: !Ref FarmersTaskDefinition
      DesiredCount: 1
      LaunchType: FARGATE
      PlatformVersion: LATEST
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref FarmersSecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
      LoadBalancers:
        - ContainerName: farmers-module
          ContainerPort: 8000
          TargetGroupArn: !Ref FarmersTargetGroup
      HealthCheckGracePeriodSeconds: 120
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
        DeploymentCircuitBreaker:
          Enable: true
          Rollback: true

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-VPC

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-PrivateSubnet1

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-PrivateSubnet2

  ECSClusterName:
    Description: ECS Cluster Name
    Value: !Ref ECSCluster
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ECSCluster

  ECSClusterArn:
    Description: ECS Cluster ARN
    Value: !GetAtt ECSCluster.Arn
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ECSClusterArn

  ALBArn:
    Description: ALB ARN
    Value: !Ref ALB
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ALB

  ALBDNSName:
    Description: ALB DNS Name
    Value: !GetAtt ALB.DNSName
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ALBDNSName

  HTTPSListenerArn:
    Description: HTTPS Listener ARN
    Value: !Ref HTTPSListener
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-HTTPSListener

  ERPSecurityGroupId:
    Description: ERP Security Group ID
    Value: !Ref ERPSecurityGroup
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ERPSecurityGroup

  ERPRDSSecurityGroupId:
    Description: ERP RDS Security Group ID
    Value: !Ref ERPRDSSecurityGroup
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ERPRDSSecurityGroup

  DBSubnetGroupName:
    Description: DB Subnet Group Name
    Value: !Ref DBSubnetGroup
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-DBSubnetGroup

  ECSTaskExecutionRoleArn:
    Description: ECS Task Execution Role ARN
    Value: !GetAtt ECSTaskExecutionRole.Arn
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ECSTaskExecutionRole

  ERPTaskRoleArn:
    Description: ERP Task Role ARN
    Value: !GetAtt ERPTaskRole.Arn
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ERPTaskRole

  ServiceDiscoveryNamespaceId:
    Description: Service Discovery Namespace ID
    Value: !Ref ServiceDiscoveryNamespace
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-ServiceDiscoveryNamespace

  AAAServiceEndpoint:
    Description: AAA Service URL
    Value: !Sub https://aaa.${DomainSuffix}

  FarmersServiceEndpoint:
    Description: Farmers Service URL
    Value: !Sub https://fm.${DomainSuffix}

  AAAGrpcEndpoint:
    Description: AAA gRPC Endpoint (internal)
    Value: !Sub aaa.kisanlink-${EnvironmentName}.local:50051

  # Endpoints for updating secrets after deploy
  AAARDSEndpoint:
    Description: AAA RDS Endpoint - Update AAADBSecret with this host value
    Value: !GetAtt AAARDSInstance.Endpoint.Address

  FarmersRDSEndpoint:
    Description: Farmers RDS Endpoint - Update FarmersDBSecret with this host value
    Value: !GetAtt FarmersRDSInstance.Endpoint.Address

  RedisEndpoint:
    Description: Redis Primary Endpoint - Update AAARedisSecret with this host value
    Value: !GetAtt RedisCluster.PrimaryEndPoint.Address

  # Secret ARNs
  AAADBSecretOutput:
    Description: ARN of AAA DB secret
    Value: !Ref AAADBSecret

  AAAJWTSecretOutput:
    Description: ARN of AAA JWT secret (shared across AAA, Farmers, ERP)
    Value: !Ref AAAJWTSecretResource
    Export:
      Name: !Sub kisanlink-${EnvironmentName}-AAAJWTSecret

  AAARedisSecretOutput:
    Description: ARN of AAA Redis secret
    Value: !Ref AAARedisSecret
